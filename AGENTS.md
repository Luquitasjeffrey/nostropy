# Nostropy — Agent & LLM Context

## Project Overview

**Nostropy** is an open-source, auditable crypto casino built on top of [Nostr](https://nostr.com). It supports provably fair games where randomness can be independently verified. Users are identified by their Nostr public key (`pubkey`). There is no traditional login — identity is entirely key-based.

## Monorepo Structure

```
nostropy/
├── server.ts              # Express entry point (backend)
├── controllers/           # Route handlers (mines.ts, user.ts)
├── middleware/            # Express middleware (auth.ts — user injection)
├── models/                # Mongoose schemas
│   ├── cryptocurrency.ts  # BTC, USDT — stored with decimal_places
│   ├── minesGame.ts       # Mines game state
│   └── user.ts            # User with multi-currency balances
├── routes/
│   ├── mines.ts           # /api/games/mines/*
│   └── user.ts            # /api/user/*
├── utils/
│   ├── db.ts              # MongoDB connection helper
│   ├── game_seed.ts       # Provably fair seed utilities
│   └── user_balance.ts    # updateUserBalance, getOrCreateUser
├── scripts/
│   └── recharge_user_balance.ts  # CLI tool to top up balances
├── types/
│   ├── express.d.ts       # Extends Express Request with `req.user`
│   └── express.ts         # AuthenticatedRequest type alias
└── frontend/              # Vite + React frontend (see frontend/AGENTS.md)
```

## Backend Stack

| Layer      | Technology                        |
|------------|-----------------------------------|
| Runtime    | Node.js + TypeScript (`ts-node`)  |
| Framework  | Express v5                        |
| Database   | MongoDB via Mongoose              |
| Dev server | `nodemon server.ts`               |

### Run the backend
```bash
npm run dev:backend   # nodemon (hot reload)
npm run start:backend # ts-node (production-like)
```

## API Routes

### `/api/games/mines/*`
All routes are protected by the `injectUser` middleware, which reads `playerPubkey` from the request body and injects the full `IUser` document into `req.user`.

| Method | Path              | Description                        |
|--------|-------------------|------------------------------------|
| POST   | `/new`            | Start a new Mines game             |
| POST   | `/set_client_seed`| Set client seed (activates board)  |
| POST   | `/reveal_one`     | Reveal a single cell               |
| POST   | `/cash_out`       | Cash out and credit winnings       |

### `/api/user/*`

| Method | Path          | Description                                        |
|--------|---------------|----------------------------------------------------|
| GET    | `/balance`    | Returns all currency balances for a pubkey         |
| GET    | `/currencies` | Returns all supported cryptocurrencies             |

## Key Design Decisions

### Identity: Nostr Pubkey
Users are identified by their Nostr `pubkey` (a hex string). There is no authentication token — the pubkey acts as a user ID. The `injectUser` middleware (`middleware/auth.ts`) creates the user on first request.

### Balances: Integer Math
All balances are stored as **integers** in the smallest currency unit (e.g. satoshis for BTC, micro-USDT for USDT). This avoids floating-point precision errors. The `decimal_places` field on `Cryptocurrency` (e.g. `8` for BTC, `6` for USDT) is used to convert to/from human-readable amounts.

```ts
// Convert float to integer before storing
const amountInt = Math.round(humanAmount * Math.pow(10, currency.decimal_places));

// Convert integer back to float for display
const humanAmount = storedInt / Math.pow(10, currency.decimal_places);
```

### Decoupled Game References
Games reference users via `user_id` — there are **no back-references** from `User` to games. To query a user's games:
```ts
MinesGame.find({ user_id: user._id });
```

### Provably Fair
Each game uses a `serverSeed` (generated by the backend, hash exposed upfront) and a `clientSeed` (provided by the player). Combined they deterministically generate the mine layout. Players can verify fairness independently after the game ends.

## Supported Currencies

Only **BTC** and **USDT** are supported. Both must exist in the `Cryptocurrency` MongoDB collection before any game can be played. Seed them with:
```bash
npx ts-node seed_currencies.ts
```

| Symbol | Decimals | Smallest Unit |
|--------|----------|---------------|
| BTC    | 8        | satoshi       |
| USDT   | 6        | micro-USDT    |

## Admin Scripts (`scripts/`)

### `recharge_user_balance.ts`
Top up a user's balance from the CLI:
```bash
npx ts-node scripts/recharge_user_balance.ts <user_id_or_pubkey> BTC=0.05 USDT=1000
```
Accepts either a MongoDB `_id` or the user's `pubkey`. Converts human amounts to integer units automatically.

## Environment Variables (`.env`)

```
MONGODB_URI=mongodb://...
PORT=5000
MINES_HOUSE_EDGE=0.01        # 1% default house edge
VITE_API_URL=http://localhost:5000
```

## Code Conventions

- **TypeScript everywhere** — both backend and frontend
- **2-space indentation**, Prettier formatting (`npm run format`)
- **Middleware injects user** — controllers access `req.user` directly, never look up users themselves
- **No direct user→game references** — always query games by `user_id`
- **Currency-agnostic balance logic** — `updateUserBalance(userId, 'BTC', deltaInt)` works for any currency